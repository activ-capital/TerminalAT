# TerminalAtService API

API `TerminalAtService` обрабатывает операции по переводу через терминал, такие как проверка и осуществление платежа.

## Конечная точка

**URL**: `/payment_app.at`  
**Метод**: `GET`

## Параметры запроса

| Параметр       | Тип    | Обязательный | Описание                          | Возможные значения               |
|----------------|--------|--------------|-----------------------------------|----------------------------------|
| `ACTION`       | string | Да           | Действие, которое нужно выполнить | Возможные значения: `check` для проверки данных или `payment` для выполнения платежа.|
| `AMOUNT`       | number | Да           | Сумма перевода в TJS              | Любое положительное число        |
| `OPER_ID`      | string | Да           | Идентификатор операции            | Должен быть строковым значением, представляющим идентификатор операции.                             |
| `PAY_DATE`       | string | Да           | Дата и время платежа              | Дата и время в формате YYYY-MM-DD HH:MM:SS |
| `SERVICE_NAME` | string | Да           | Название провайдера или банка отправителя  | Любое допустимое название|
| `PHONE_NUMBER` | string | Да           | Номер телефона                    | Должен быть числовым значением длиной ровно 12 символов без пробелов, тире или других специальных символов.|
| `TERMINAL_ID`  | string | Да           | идентификатор терминала           | Должен быть строковым значением, представляющим идентификатор терминала.                             |

## Примеры запросов

**Примеры запросов:**

**Запрос на проверку (check)** `GET`

```HTTP
/payment_app.at?ACTION=check&OPER_ID=123e4567-e89b-12d3-a456-426614174000&PAY_DATE=2024-07-25 14:30:00&SERVICE_NAME=example_service&PHONE_NUMBER=examplenumber&TERMINAL_ID=terminal123
```

Ответ на запрос на проверку (check)

```json
{
    "code": 302,
    "message": "Получатель найден"
  "payload": {
    "service_name": "example_service",
    "action": "check",
    "terminal_id": "12345",
    "phone_number": "992937870880",
    "fio": "Иван И.",
    "oper_id": "123e4567-e89b-12d3-a456-426614174000",
    "transaction_date": "2024-07-25 14:30:00"
  }
}
```

Запрос на оплату (payment) `GET`

```HTTP
/payment_app.at?ACTION=payment&AMOUNT=100.50&OPER_ID=123e4567-e89b-12d3-a456-426614174000&PAY_DATE=2024-07-25 14:30:00&SERVICE_NAME=example_service&PHONE_NUMBER=examplenumber&TERMINAL_ID=terminal123
```

Ответ на запрос на оплату (payment)

```json
{
    "code": 202,
    "message": "Перевод зачислен"
  "payload": {
    "service_name": "example_service",
    "action": "payment",
    "terminal_id": "12345",
    "phone_number": "992937870880",
    "fio": "Иван И.",
    "oper_id": "123e4567-e89b-12d3-a456-426614174000",
    "transaction_date": "2024-07-25 14:30:00"
    "amount": 100.50
  }
}
```

### Успешные статус-коды (Success Status Codes)

| Статус-код | Сообщение                 | Описание                                                   |
|------------|---------------------------|------------------------------------------------------------|
| `202`      | `Перевод зачислен`        | Платеж успешно выполнен, сумма зачислена на счет получателя. |
| `302`      | `Получатель найден`       | Информация о получателе найдена и возвращена.              |

### Ошибочные статус-коды (Fail Status Codes)

| Статус-код | Сообщение                                | Описание                                                                                                 |
|------------|------------------------------------------|----------------------------------------------------------------------------------------------------------|
| `102`      | `Получатель не найден`                   | Запрос не может быть обработан, так как указанный получатель не найден.|
| `201`      | `Не найден результат проверки`           | Запрос на завершение не может быть обработан, так как результат предварительной проверки не найден.|
| `400`      | `Неверный запрос`                        | Один или несколько параметров запроса отсутствуют или неверны.  |
| `401`      | `Неавторизован`                          | Доступ запрещен, необходимо предоставить корректные учетные данные. |
| `107`      | `Дубликат запроса оплаты`                | Запрос на оплату не может быть обработан, так как нарушена уникальность `OPER_ID`.|
| `500`      | `Внутренняя ошибка сервера`              | Произошла ошибка на сервере при обработке запроса.              |
| `503`      | `Сервис недоступен`                      | Сервис временно недоступен, попробуйте позже.                   |

Если запрос нарушает уникальность параметра OPER_ID (дублируется в системе), сервер возвращает следующий ответ:
```json
{
  "error_code": 107,
  "message": "Дубликат запроса оплаты",
  "payload": {
    "oper_id": "abc123",
    "status": "failed" //or success
  }
}
```
При возникновении дубликата сервер возвращает текущий статус платежа и его идентификатор. Вы можете использовать эти данные (oper_id и status) для проверки состояния платежа.


## Авторизация
### Для обеспечения безопасности запросы к API должны быть подписаны с использованием асимметричной криптографии (публичного и приватного ключа)

### Механизм авторизации:
	1. Подготовка строки запроса: Клиент должен собрать строку из обязательных параметров запроса в следующем порядке: OPER_ID, ACTION, SERVICE_NAME, PHONE_NUMBER.
 Пример строки:
 
 ```plaintext
OPER_ID=123e4567-e89b-12d3-a456-426614174000&ACTION=check&SERVICE_NAME=example_name&PHONE_NUMBER=99255000000
```
#### Важно: В строку для подписи включаются только поля: OPER_ID, ACTION, SERVICE_NAME, PHONE_NUMBER. Остальные параметры запроса не включаются в подпись.

      2. Генерация подписи: Используйте приватный ключ для подписания строки запроса. Подпись создаётся с использованием алгоритма HMAC-SHA256.
 Заголовки запроса:

	•	X-Public-Key: публичный ключ клиента (используется сервером для проверки подписи).
	•	X-Signature: подпись, сгенерированная с помощью приватного ключа клиента.
### Пример запроса:
```http
GET /payment_app.at?ACTION=check&OPER_ID=123e4567-e89b-12d3-a456-426614174000&PAY_DATE=2024-07-25%2014:30:00&SERVICE_NAME=example_service&PHONE_NUMBER=992937870880 HTTP/1.1
Host: example.com
X-Public-Key: -----BEGIN PUBLIC KEY-----
<ваш публичный ключ>
-----END PUBLIC KEY-----
X-Signature: <сгенерированная подпись>
```
### Процесс генерации подписи
• HMAC-SHA256: Подпись генерируется с использованием этого алгоритма и вашего секретного ключа.

• Base64: Результат кодируется в формате Base64 и передаётся в заголовке X-Signature.


### Пример кода для генерации подписи (Go):
```GO
import (
    "crypto/hmac"
    "crypto/sha256"
    "encoding/base64"
)
func main() {
	privateKeyPath := "privateKeyPath"

	// Загрузка секретного ключа из указанного файла
	secretKey, err := loadSecretKey(privateKeyPath)

	// Формирование сообщения, которое будет подписано
	message := fmt.Sprintf("OPER_ID=%s&ACTION=%s&SERVICE_NAME=%s&PHONE_NUMBER=%s", operID, action, serviceName, phoneNumber)

	// Создаём подпись
	signature, err := createHMACSignature(secretKey, message)

	// Кодируем подпись в Base64
	signatureBase64 := base64.StdEncoding.EncodeToString(signature)
	fmt.Printf("Подпись (Base64): %s\n", signatureBase64)
}

// Функция для создания HMAC-SHA256 подписи
func createHMACSignature(secretKey []byte, message string) ([]byte, error) {
	h := hmac.New(sha256.New, secretKey)
	h.Write([]byte(message))
	return h.Sum(nil), nil
}

// Функция для загрузки приватного ключа
func loadSecretKey(path string) ([]byte, error) {
	data, err := ioutil.ReadFile(path)
	if err != nil {
		return nil, fmt.Errorf("не удалось прочитать файл: %v", err)
	}

	block, _ := pem.Decode(data)
	if block == nil || block.Type != "PRIVATE KEY" {
		return nil, fmt.Errorf("неправильный формат ключа")
	}

	return block.Bytes, nil
}

```
## Пример строки для подписи:
```plaintext
OPER_ID=123e4567-e89b-12d3-a456-426614174000&ACTION=check&SERVICE_NAME=example_service&PHONE_NUMBER=992550000000
```
## Пример сгенерированной подписи:
```plaintext
Подпись (Base64): mFz5T2yA1y3YhjOY+pLlfgfMT9k2Oy3wJ/nYRw9y1uo=
```

### Ошибки авторизации:
	•	401: Unauthorized – Неверная подпись или отсутствует публичный ключ.
	•	400: Bad Request – Отсутствуют обязательные параметры запроса.
	•	500: Internal Server Error – Ошибка загрузки ключей на сервере.
 
 
 ### Примечания
 	•	Убедитесь, что используете один и тот же приватный ключ для генерации подписи и соответствующий публичный ключ для проверки подписи на сервере.
	•	Строка для подписи должна быть сформирована строго в указанном порядке параметров: OPER_ID, ACTION, SERVICE_NAME, PHONE_NUMBER.
	•	Любые дополнительные параметры запроса не включаются в строку для подписи.
	•	Все строки сообщений перед передачей в алгоритм HMAC-SHA256 должны быть закодированы в формате UTF-8.
	•	Подпись генерируется с использованием алгоритма HMAC-SHA256. Секретный ключ должен быть передан в виде байтовой строки.
	•	Полученная подпись из HMAC-SHA256 должна быть закодирована в Base64 для передачи в заголовке `X-Signature`.
